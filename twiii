import '../Frontend/css/widgets.css';
import Cesium from 'cesium';
import axios from 'axios';

const viewer = new Cesium.Viewer('cesiumContainer');

const backendUrl = 'http://localhost:5000';

const fetchFilenames = () => {
  axios.get(`${backendUrl}/api/getFilenames`)
    .then((response) => {
      const filenames = response.data;

      const dropdown = document.createElement('select');
      filenames.forEach((filename) => {
        const option = document.createElement('option');
        option.text = filename;
        option.value = filename;
        dropdown.appendChild(option);
      });

      const filenameDropdown = document.getElementById('filenameDropdown');
      filenameDropdown.innerHTML = '';
      filenameDropdown.appendChild(dropdown);
    })
    .catch((error) => {
      console.error('Error fetching filenames:', error);
    });
}

const fileUploadForm = document.getElementById('czmlFileUploadForm');
const fileInput = document.getElementById('czmlFileInput');

fileUploadForm.addEventListener('submit', (event) => {
  event.preventDefault();

  const file = fileInput.files[0];

  if (file) {
    const formData = new FormData();
    formData.append('czmlFile', file);

    axios.post(`${backendUrl}/api/uploadCzml`, formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
    })
      .then((response) => {
        console.log(response.data.message);
        fetchFilenames();
      })
      .catch((error) => {
        console.error('Error uploading CZML file:', error);
      });
  }
});

const loadCzmlFile = (selectedFilename) => {
  Cesium.CzmlDataSource.load(`/uploads/${selectedFilename}`)
    .then((dataSource) => {
      viewer.dataSources.removeAll();
      viewer.dataSources.add(dataSource);
    })
    .catch((error) => {
      console.error('Error loading CZML file:', error);
    });
}

const filenameDropdown = document.getElementById('filenameDropdown');
filenameDropdown.addEventListener('change', (event) => {
  const selectedFilename = event.target.value;
  loadCzmlFile(selectedFilename);
});

fetchFilenames();
