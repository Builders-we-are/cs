from flask import Flask, jsonify, request, send_file, Response
from flask_cors import CORS
from pymongo import MongoClient
import os


app = Flask(__name__)
CORS(app) 
# MongoDB connection
client = MongoClient('mongodb://localhost:27017/')
db = client['cesuim']  # Replace with your actual database name
collection = db['cesuimfiless']  # Replace with your collection name

@app.route('/api/getFilenames')
def get_filenames():
    # Query MongoDB for filenames
    filenames = [doc['name'] for doc in collection.find({}, {'_id': 0, 'name': 1})]

    return jsonify(filenames)

@app.route('/api/getCzmlFile/<filename>')
def get_czml_file(filename):
    czml_path = os.path.join(upload_dir, filename)

    if not os.path.isfile(czml_path):
        return jsonify({'error': 'CZML file not found'})

    # Send the CZML file to the frontend with appropriate headers
    return send_file(czml_path, as_attachment=True, mimetype='application/json')

# Define the directory to store CZML files
upload_dir = 'backend/uploads'

@app.route('/api/uploadCzml', methods=['POST'])
def upload_czml():

    try:

        if 'czmlFile' not in request.files:
            return jsonify({'error': 'No file part'})

        file = request.files['czmlFile']

        if file.filename == '':
            return jsonify({'error': 'No selected file'})
        
        if not file.filename.endswith('.czml'):
            return jsonify({'error': 'File must have a .czml extension'})


        # Save the file to the server
        if file:
            filename = os.path.join(upload_dir, file.filename)
            file.save(filename)

            # Add file information to MongoDB
            file_info = {'name': file.filename, 'location': filename}
            collection.insert_one(file_info)

            return jsonify({'message': 'CZML file uploaded and data saved successfully'})

    except Exception as e:
        return jsonify({'error': f'Error uploading CZML file: {str(e)}'})


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
